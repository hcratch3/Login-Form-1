<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>QRCode　リーダー</title>
    <link rel="shortcut icon" href="https://qrcode-reader.netlify.app/images/fav_icon.png" type="image/x-icon">
    <link rel="stylesheet" href="./QRCode　リーダー_files/font-awesome.min.css">
    <link href="./QRCode　リーダー_files/css" rel="stylesheet">
    <link rel="stylesheet" href="./QRCode　リーダー_files/bulmaswatch.min.css">
    <!-- Bulma Version 0.7.5-->
    <link rel="stylesheet" href="./QRCode　リーダー_files/bulma.min.css">


</head>

<body>
    <section class="hero is-fullheight is-default is-bold">
        <div id="app"><div class="hero-head"><nav class="navbar"><div class="container"><div class="navbar-brand"><a href="https://qrcode-reader.netlify.app/" class="navbar-item"><i aria-hidden="true" class="fa fa-th fa-rotate-90" style="color: slategrey;"></i> <p style="padding-left: 5px;">QRCode Reader</p></a> <span data-target="navbarMenu" class="navbar-burger burger"><span></span> <span></span> <span></span></span></div> <div id="navbarMenu" class="navbar-menu"><div class="navbar-end"><span class="navbar-item"><a class="button is-outlined"><span class="icon"><i aria-hidden="true" class="fa fa-video-camera"></i></span> <span>Camera</span></a></span> <span class="navbar-item"><a class="button is-outlined"><span class="icon"><i aria-hidden="true" class="fa fa-table"></i></span> <span>DataCheck</span></a></span> <span class="navbar-item"><a class="button is-outlined"><span class="icon"><i aria-hidden="true" class="fa fa-download"></i></span> <span>Export</span></a></span> <span class="navbar-item"><a class="button is-outlined"><span class="icon"><i aria-hidden="true" class="fa fa-upload"></i></span> <span>Import</span> <input type="file" accept=".csv" class="file-input"></a></span> <span class="navbar-item"><a class="button is-outlined"><span class="icon"><i aria-hidden="true" class="fa fa-bomb"></i></span> <span>Reset</span></a></span></div></div></div></nav></div> <div class="hero-body"><div class="container has-text-centered"><div class="columns is-vcentered"><div class="column is-5"><figure class="image is-4by3" style="margin-top: -384.7px;"><video id="camera" width="700" height="700" muted="muted" class="image"></video><input type="text" id="class" name="class"> <canvas id="picture" width="700" height="700" class="image"></canvas></figure></div> <!----></div></div></div> <div class="hero-body" style="display: none;"><div class="container has-text-centered"><table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"><thead><tr><th> 受付番号 </th> <th> 氏名 </th> <th> 出欠状況 </th> <th> 受付時間 </th></tr></thead> <tbody><tr><td>10001</td> <td>すずっきー</td> <td>-----</td> <td>-----</td></tr></tbody><tbody><tr><td>10002</td> <td>あらかーわ</td> <td>-----</td> <td>-----</td></tr></tbody><tbody><tr><td>10003</td> <td>あみあみしま</td> <td>-----</td> <td>-----</td></tr></tbody></table></div></div> <div class="hero-foot"><div class="container"><div class="tabs is-centered"></div></div></div></div>
    </section>

    <script src="./QRCode　リーダー_files/jsQR.min.js.ダウンロード"></script>
    <script src="./QRCode　リーダー_files/moment.js.ダウンロード"></script>
    <script src="./QRCode　リーダー_files/vue.js.ダウンロード"></script>
    <script src="./QRCode　リーダー_files/sha256.min.js.ダウンロード"></script>
    <script>
      var class = document.getElementById('class');
    //localStorage.removeItem("EMPLOYEE_DATA");
    let vueApp = new Vue({
        el: '#app',
        data: {
            isMenuOpen: false,
            pageMode: "Camera", // "Camera" , "DataCheck" 
            saveLSkey: "EMPLOYEE_DATA",

            employeeData: [],

            cameraData: {
                audio: false,
                video: {
                    width: 700,
                    height: 700,
                    facingMode: "user" // フロントカメラを利用する
                }
            },

            video: null,
            canvas: null,
            ctx: null,

            topMargin: 0,
            isQRget: false,

            employeeName: "",
            employeeId: "",
            attendanceData: "",
        },
        methods: {

            setTopMargin: function () {
                // data にリサイズ後のウィンドウ幅を代入
                if (window.innerWidth > 768) {
                    this.topMargin = ((window.innerWidth) * -0.25) + ((window.innerHeight) * 0.1)

                } else {
                    this.topMargin = (window.innerWidth) * -0.7;
                }
            },

            cameraRun: function () {
                let video = this.video;
                navigator.mediaDevices.getUserMedia(this.cameraData)
                    .then((stream) => {
                        video.srcObject = stream;
                        video.onloadedmetadata = (e) => {
                            video.play();
                            // QRコードのチェック開始
                            this.checkPicture();
                        };
                    })
                    .catch((err) => {
                        console.log(err.name + ": " + err.message);
                    });
            },

            checkPicture: function () {
                let ctx = this.ctx;
                let video = this.video;
                let canvas = this.canvas;
                // カメラの映像をCanvasに複写
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                // QRコードの読み取り
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let code = jsQR(imageData.data, canvas.width, canvas.height);

                //----------------------
                // 存在する場合
                //----------------------
                if (code) {
                    setTimeout(() => {
                        this.isQRget = true;
                        //キーの決め打ちで見やすいが、あんまりよろしくない！
                        this.employeeData.forEach(el => {
                            let base64id = btoa(unescape(encodeURIComponent(el["id"])));
                            // if (el["id"] == code.data) {
                            if (el["id"] == code.data || base64id == code.data) {
                                video.pause();
                                this.employeeId = el["id"];
                                this.employeeName = el["name"];
                                this.attendanceData = moment().format('YYYY/MM/DD HH:mm:ss dddd');

                                el["attendance"] = "出席済み";
                                el["date"] = moment().format('YYYY/MM/DD HH:mm:ss dddd');
                                localStorage.setItem(this.saveLSkey, JSON.stringify(this
                                    .employeeData));
                                console.log(this.employeeData);
                            }
                        })
                    }, 300);
                }
                //----------------------
                // 存在しない場合
                //----------------------
                else {
                    // 0.3秒後にもう一度チェックする
                    setTimeout(() => {
                        this.checkPicture();
                    }, 300);
                }
            },

            cameraRestart: function () {
                this.cameraRun();
                //this.video.play();
                this.isQRget = false;
            },

            DownloadCsv: function () {
                let csv = '\ufeff';
                Object.keys(this.employeeData[0]).forEach(function (key) {
                    csv += key + ","
                })
                csv = csv.replace(new RegExp("," + "$"), "\n");

                this.employeeData.forEach(el => {
                    let line = "";
                    Object.keys(this.employeeData[0]).forEach(function (key) {
                        line += el[key] + ','
                    })
                    line = line.replace(new RegExp("," + "$"), "\n");
                    csv += line;
                })

                let blob = new Blob([csv], {
                    type: 'text/csv'
                })
                let link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);

                link.download = 'EXPORT_DATA.csv';
                link.click();
            },

            ImportCsv: function (csvEv) {
                let file = csvEv.target.files[0];
                let reader = new FileReader();
                let vueThis = this;

                //読み込み完了後に実行される
                reader.onload = function (csvEv) {
                    let res = csvEv.target.result;
                    let splitData = res.split('\n'); // 1行ごとに分割する

                    let jsonArray = [];
                    // 1行目から「項目名」の配列を生成する
                    let items = splitData[0].split(',');

                    // CSVデータの配列の各行をループ処理する
                    //// 配列の先頭要素(行)は項目名のため処理対象外
                    //// 配列の最終要素(行)は空のため処理対象外
                    for (let i = 1; i < splitData.length - 1; i++) {
                        let a_line = new Object();
                        // カンマで区切られた各データに分割する
                        let splitDataD = splitData[i].split(',');
                        //// 各データをループ処理する
                        for (let j = 0; j < items.length; j++) {
                            // 要素名：items[j]
                            // データ：splitDataD[j]
                            a_line[items[j]] = splitDataD[j];
                        }
                        jsonArray.push(a_line);
                    }

                    vueThis.employeeData = jsonArray;
                    console.log(vueThis.employeeData);
                    localStorage.setItem(vueThis.saveLSkey, JSON.stringify(vueThis.employeeData));
                }
                reader.readAsText(file, "Shift_JIS");
            },

            ResetSetting: function () {
                if (confirm(
                        "データを初期化しますけどよろしいでっか?" + "\r\n\r\n" +
                        "もしあれやったらEXPORTできますさかいにご利用なさってください。")) {
                    localStorage.removeItem(this.saveLSkey);
                    location.reload();
                }
            },
        },

        mounted: function () {
            this.video = document.querySelector("#camera");
            this.canvas = document.querySelector("#picture");
            this.ctx = this.canvas.getContext("2d");

            axios.get('http://example.com/"+class+".json') // サーバーのエンドポイントを適切に変更してください
                .then(response => {
                    this.employeeData = response.data;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });

            this.cameraRun();
            this.setTopMargin();
            window.addEventListener('resize', this.setTopMargin, false);
        },

        watch: {
            pageMode: function () {
                if (this.pageMode == "Camera") {
                    this.cameraRun();
                }
                if (this.pageMode == "DataCheck" && this.video) {
                    this.isQRget = false;
                    this.video.pause();
                }
            },

        },

        beforeDestroy: function () {
            // インスタンスを破棄する前に、イベントリスナから削除
            window.removeEventListener('resize', this.setTopMargin, false);
        }

    })
</script>

    <style type="text/css">
        html,
        body {
            font-family: 'Open Sans';
        }

        img {
            padding: 5px;
            border: 1px solid #ccc;
        }

        /* リーダー部分 */
        #picture {
            display: none;
        }
    </style>


</body></html>
